[tools]
# Node.js 24 - do not upgrade to 25 until distroless supports nodejs25
# See: https://github.com/GoogleContainerTools/distroless
nodejs = "24"
go = "1.25"
pnpm = "latest"
"go:github.com/sethvargo/ratchet" = "latest"
helm = "3.19.4"

[env]
DATABASE_USERNAME = "unleash"
DATABASE_PASSWORD = "unleash"
DATABASE_NAME = "unleash"
DATABASE_HOST = "localhost"
DATABASE_SSL = "false"
INIT_ADMIN_API_TOKENS = "*:*.unleash4all"
GOOGLE_IAP_AUDIENCE = "/projects/123/global/backendServices/123"
OAUTH_JWT_AUTH = "true"
OAUTH_JWT_AUDIENCE = "test-audience"
OAUTH_JWT_ISSUER = "https://auth.nais.io"
OAUTH_JWT_KEYSET = "https://auth.nais.io/oauth/v2/keys"

[tasks.install]
description = "Install all dependencies"
run = "pnpm install"

[tasks.build]
description = "Build packages (all or specific: mise run build [shared|v5|v6|v7])"
usage = 'arg "[package]" help="Package to build: shared, v5, v6, v7, or empty for all"'
run = """
if [ -z "${usage_package:-}" ]; then
  pnpm -r build
elif [ "$usage_package" = "shared" ]; then
  pnpm --filter @nais/unleash-shared build
else
  pnpm --filter @nais/unleash-shared build
  pnpm --filter unleash-$usage_package build
fi
"""
depends = ["install"]

[tasks.lint]
description = "Lint packages (all or specific: mise run lint [shared|v5|v6|v7])"
usage = 'arg "[package]" help="Package to lint: shared, v5, v6, v7, or empty for all"'
run = """
if [ -z "${usage_package:-}" ]; then
  pnpm -r lint
elif [ "$usage_package" = "shared" ]; then
  pnpm --filter @nais/unleash-shared lint
else
  pnpm --filter unleash-$usage_package lint
fi
"""

# Database tasks
[tasks."db:start"]
description = "Start PostgreSQL database in Docker"
run = "docker compose up -d postgres"

[tasks."db:stop"]
description = "Stop PostgreSQL database"
run = "docker compose down"

[tasks."db:wait"]
description = "Wait for database to be ready"
run = """
echo "Waiting for PostgreSQL to be ready..."
for i in {1..30}; do
  if docker compose exec -T postgres pg_isready -U unleash > /dev/null 2>&1; then
    echo "Database is ready!"
    exit 0
  fi
  echo "Waiting... ($i/30)"
  sleep 1
done
echo "Database failed to start"
exit 1
"""
depends = ["db:start"]

# Test tasks
[tasks.test]
description = "Run tests (all or specific: mise run test [shared|v5|v6|v7])"
usage = 'arg "[package]" help="Package to test: shared, v5, v6, v7, or empty for all"'
run = """
if [ -z "${usage_package:-}" ]; then
  pnpm -r test
elif [ "$usage_package" = "shared" ]; then
  pnpm --filter @nais/unleash-shared test
else
  pnpm --filter unleash-$usage_package test
fi
"""
depends = ["build", "db:wait"]

# Start server
[tasks.start]
description = "Start unleash server (mise run start <v5|v6|v7>)"
usage = '''
arg "<version>" help="Version to start: v5, v6, or v7" {
  choices "v5" "v6" "v7"
}
'''
run = 'cd packages/unleash-$usage_version && pnpm start'
depends = ["build", "db:wait"]

# Development tasks
[tasks.dev]
description = "Start development environment with database"
run = """
echo "Starting PostgreSQL..."
mise run db:start
mise run db:wait
echo ""
echo "Database ready! You can now run:"
echo "  mise run start v5"
echo "  mise run start v6"
echo "  mise run start v7"
echo ""
echo "To run tests: mise run test"
echo "To stop database: mise run db:stop"
"""

[tasks.clean]
description = "Clean all build artifacts and stop database"
run = """
pnpm -r exec rm -rf dist coverage
rm -rf node_modules packages/*/node_modules
docker compose down -v
"""

# Docker tasks
[tasks."docker:build"]
description = "Build Docker image (mise run docker:build [v5|v6|v7|all])"
usage = 'arg "[version]" help="Version to build: v5, v6, v7, all, or empty for all"'
run = """
if [ -z "${usage_version:-}" ] || [ "$usage_version" = "all" ]; then
  for version in $(ls -d packages/unleash-v* 2>/dev/null | sed 's|packages/unleash-||'); do
    echo "Building Docker image for ${version}..."
    docker build --build-arg UNLEASH_VERSION=${version} -t nais-unleash:${version}-local .
  done
else
  echo "Building Docker image for $usage_version..."
  docker build --build-arg UNLEASH_VERSION=$usage_version -t nais-unleash:$usage_version-local .
fi
"""

[tasks."docker:run"]
description = "Run full stack with docker-compose"
run = "docker compose up --build"

# Ratchet tasks for GitHub Actions
[tasks."ratchet:pin"]
description = "Pin GitHub Actions to specific commit SHAs"
run = "ratchet pin .github/workflows/*.yml"

[tasks."ratchet:update"]
description = "Update pinned GitHub Actions to latest versions"
run = "ratchet update .github/workflows/*.yml"

[tasks."ratchet:lint"]
description = "Check if GitHub Actions are properly pinned"
run = "ratchet lint .github/workflows/*.yml"

[tasks."ratchet:unpin"]
description = "Unpin GitHub Actions (restore to tags)"
run = "ratchet unpin .github/workflows/*.yml"

# Helm tasks
[tasks."helm:lint"]
description = "Lint Helm charts"
run = "helm lint charts/*"

[tasks."helm:template"]
description = "Template Helm charts for debugging"
run = """
for chart in charts/*/; do
  echo "=== Templating $(basename $chart) ==="
  helm template test "$chart"
done
"""
