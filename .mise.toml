[tools]
# Node.js 24 - do not upgrade to 25 until distroless supports nodejs25
# See: https://github.com/GoogleContainerTools/distroless
nodejs = "24"
go = "1.25"
pnpm = "latest"
"go:github.com/sethvargo/ratchet" = "latest"
helm = "3.19.4"

[env]
DATABASE_USERNAME = "unleash"
DATABASE_PASSWORD = "unleash"
DATABASE_NAME = "unleash"
DATABASE_HOST = "localhost"
DATABASE_PORT = "15432"
DATABASE_SSL = "false"
INIT_ADMIN_API_TOKENS = "*:*.unleash4all"
GOOGLE_IAP_AUDIENCE = "/projects/123/global/backendServices/123"
OAUTH_JWT_AUTH = "true"
OAUTH_JWT_AUDIENCE = "test-audience"
OAUTH_JWT_ISSUER = "https://auth.nais.io"
OAUTH_JWT_KEYSET = "https://auth.nais.io/oauth/v2/keys"

[tasks.install]
description = "Install all dependencies"
run = "pnpm install"

[tasks.build]
description = "Build packages (all or specific: mise run build [shared|v5|v6|v7])"
usage = 'arg "[package]" help="Package to build: shared, v5, v6, v7, or empty for all"'
run = """
if [ -z "${usage_package:-}" ]; then
  pnpm -r build
elif [ "$usage_package" = "shared" ]; then
  pnpm --filter @nais/unleash-shared build
else
  pnpm --filter @nais/unleash-shared build
  pnpm --filter unleash-$usage_package build
fi
"""
depends = ["install"]

[tasks.lint]
description = "Lint packages (all or specific: mise run lint [shared|v5|v6|v7])"
usage = 'arg "[package]" help="Package to lint: shared, v5, v6, v7, or empty for all"'
run = """
if [ -z "${usage_package:-}" ]; then
  pnpm -r lint
elif [ "$usage_package" = "shared" ]; then
  pnpm --filter @nais/unleash-shared lint
else
  pnpm --filter unleash-$usage_package lint
fi
"""

# Database tasks
[tasks."db:start"]
description = "Start PostgreSQL database in Docker (port 15432)"
run = "docker compose up -d postgres"

[tasks."db:stop"]
description = "Stop PostgreSQL database"
run = "docker compose down"

[tasks."db:reset"]
description = "Reset database (drop and recreate)"
run = """
echo "Resetting database..."
docker compose exec -T postgres psql -U unleash -d postgres -c "DROP DATABASE IF EXISTS unleash;" > /dev/null 2>&1
docker compose exec -T postgres psql -U unleash -d postgres -c "CREATE DATABASE unleash;" > /dev/null 2>&1
echo "Database reset complete"
"""
depends = ["db:wait"]

[tasks."db:wait"]
description = "Wait for database to be ready"
run = """
echo "Waiting for PostgreSQL to be ready on port ${DATABASE_PORT:-15432}..."
for i in {1..30}; do
  if docker compose exec -T postgres pg_isready -U unleash > /dev/null 2>&1; then
    echo "Database is ready!"
    exit 0
  fi
  echo "Waiting... ($i/30)"
  sleep 1
done
echo "Database failed to start"
exit 1
"""
depends = ["db:start"]

# Test tasks
[tasks.test]
description = "Run tests (all or specific: mise run test [shared|v5|v6|v7])"
usage = 'arg "[package]" help="Package to test: shared, v5, v6, v7, or empty for all"'
run = """
if [ -z "${usage_package:-}" ]; then
  # Run all tests sequentially with database reset between versions
  echo "Running tests sequentially (shared, v5, v6, v7)..."
  pnpm --filter @nais/unleash-shared test && \
  mise run db:reset && pnpm --filter unleash-v5 test && \
  mise run db:reset && pnpm --filter unleash-v6 test && \
  mise run db:reset && pnpm --filter unleash-v7 test
elif [ "$usage_package" = "shared" ]; then
  pnpm --filter @nais/unleash-shared test
else
  mise run db:reset && pnpm --filter unleash-$usage_package test
fi
"""
depends = ["build", "db:wait"]

# Start server
[tasks.start]
description = "Start unleash server (mise run start <v5|v6|v7>)"
usage = '''
arg "<version>" help="Version to start: v5, v6, or v7" {
  choices "v5" "v6" "v7"
}
'''
run = 'cd packages/unleash-$usage_version && pnpm start'
depends = ["build", "db:wait"]

# Development tasks
[tasks.dev]
description = "Start development environment with database"
run = """
echo "Database ready! You can now run:"
echo "  mise run start v5"
echo "  mise run start v6"
echo "  mise run start v7"
echo ""
echo "To run tests: mise run test"
echo "To stop database: mise run db:stop"
"""
depends = ["build", "db:wait"]

[tasks.clean]
description = "Clean all build artifacts and stop database"
run = """
pnpm -r exec rm -rf dist coverage
rm -rf node_modules packages/*/node_modules
docker compose down -v 2>/dev/null || true
"""

# Docker tasks
[tasks."docker:build"]
description = "Build Docker image (mise run docker:build [v5|v6|v7|all])"
usage = 'arg "[version]" help="Version to build: v5, v6, v7, all, or empty for all"'
run = """
if [ -z "${usage_version:-}" ] || [ "$usage_version" = "all" ]; then
  for version in $(ls -d packages/unleash-v* 2>/dev/null | sed 's|packages/unleash-||'); do
    echo "Building Docker image for ${version}..."
    docker build --build-arg UNLEASH_VERSION=${version} -t nais-unleash:${version}-local .
  done
else
  echo "Building Docker image for $usage_version..."
  docker build --build-arg UNLEASH_VERSION=$usage_version -t nais-unleash:$usage_version-local .
fi
"""

[tasks."docker:run"]
description = "Run full stack with docker-compose"
run = "docker compose up --build"

[tasks."docker:e2e"]
description = "Run end-to-end tests for Docker containers (mise run docker:e2e [v5|v6|v7|all])"
usage = 'arg "[version]" help="Version to test: v5, v6, v7, all, or empty for all"'
run = """
#!/bin/bash
set -e

# Colors for output
RED='\\033[0;31m'
GREEN='\\033[0;32m'
YELLOW='\\033[1;33m'
NC='\\033[0m' # No Color

test_container() {
  local version=$1
  local image="nais-unleash:${version}-local"
  local container_name="unleash-e2e-${version}"
  local port=$((14242 + ${version#v}))  # v5=14247, v6=14248, v7=14249

  echo -e "${YELLOW}Testing ${version}...${NC}"

  # Check if image exists
  if ! docker image inspect "$image" > /dev/null 2>&1; then
    echo -e "${RED}Image $image not found. Run 'mise run docker:build ${version}' first.${NC}"
    return 1
  fi

  # Start container
  echo "  Starting container on port $port..."
  docker run -d --name "$container_name" \\
    --network unleash_unleash \\
    -p "${port}:4242" \\
    -e DATABASE_HOST=postgres \\
    -e DATABASE_USERNAME=unleash \\
    -e DATABASE_PASSWORD=unleash \\
    -e DATABASE_NAME=unleash \\
    -e DATABASE_SSL=false \\
    -e DATABASE_PORT=5432 \\
    -e INIT_ADMIN_API_TOKENS="*:*.unleash4all" \\
    -e GOOGLE_IAP_AUDIENCE="/projects/123/global/backendServices/123" \\
    "$image" > /dev/null

  # Wait for startup
  echo "  Waiting for server to start..."
  local max_attempts=30
  local attempt=0
  while [ $attempt -lt $max_attempts ]; do
    if curl -s "http://localhost:${port}/health" > /dev/null 2>&1; then
      break
    fi
    attempt=$((attempt + 1))
    sleep 1
  done

  if [ $attempt -eq $max_attempts ]; then
    echo -e "${RED}  Server failed to start within ${max_attempts}s${NC}"
    docker logs "$container_name" 2>&1 | tail -20
    docker rm -f "$container_name" > /dev/null 2>&1
    return 1
  fi

  # Test health endpoint
  echo "  Testing /health endpoint..."
  local health_response=$(curl -s "http://localhost:${port}/health")
  if ! echo "$health_response" | grep -q '"health":"GOOD"'; then
    echo -e "${RED}  Health check failed: $health_response${NC}"
    docker rm -f "$container_name" > /dev/null 2>&1
    return 1
  fi
  echo -e "${GREEN}  ‚úì Health check passed${NC}"

  # Test prometheus endpoint
  echo "  Testing /internal-backstage/prometheus endpoint..."
  local prom_response=$(curl -s "http://localhost:${port}/internal-backstage/prometheus")
  if ! echo "$prom_response" | grep -q "^# HELP"; then
    echo -e "${RED}  Prometheus endpoint failed${NC}"
    docker rm -f "$container_name" > /dev/null 2>&1
    return 1
  fi
  echo -e "${GREEN}  ‚úì Prometheus endpoint passed${NC}"

  # Test API with token
  echo "  Testing /api/admin/instance-admin/statistics with API token..."
  local api_response=$(curl -s -w "%{http_code}" -o /dev/null \\
    -H "Authorization: *:*.unleash4all" \\
    "http://localhost:${port}/api/admin/instance-admin/statistics")
  if [ "$api_response" != "200" ]; then
    echo -e "${RED}  API test failed with status: $api_response${NC}"
    docker rm -f "$container_name" > /dev/null 2>&1
    return 1
  fi
  echo -e "${GREEN}  ‚úì API authentication passed${NC}"

  # Cleanup
  docker rm -f "$container_name" > /dev/null 2>&1
  echo -e "${GREEN}‚úì ${version} passed all tests${NC}"
  return 0
}

# Determine which versions to test
versions=""
if [ -z "${usage_version:-}" ] || [ "$usage_version" = "all" ]; then
  versions=$(ls -d packages/unleash-v* 2>/dev/null | sed 's|packages/unleash-||')
else
  versions="$usage_version"
fi

# Run tests
failed=0
for version in $versions; do
  if ! test_container "$version"; then
    failed=$((failed + 1))
  fi
  echo ""
done

# Summary
if [ $failed -gt 0 ]; then
  echo -e "${RED}$failed version(s) failed e2e tests${NC}"
  exit 1
else
  echo -e "${GREEN}All e2e tests passed!${NC}"
fi
"""
depends = ["docker:build", "db:start"]

[tasks."docker:smoke"]
description = "Quick smoke test for a Docker image (mise run docker:smoke <v5|v6|v7>)"
usage = '''
arg "<version>" help="Version to smoke test: v5, v6, or v7" {
  choices "v5" "v6" "v7"
}
'''
run = """
#!/bin/bash
set -e
image="nais-unleash:${usage_version}-local"

echo "Smoke testing $image..."

# Check image exists
if ! docker image inspect "$image" > /dev/null 2>&1; then
  echo "Error: Image $image not found. Run 'mise run docker:build ${usage_version}' first."
  exit 1
fi

# Test that the container can at least start and show help/version
echo "Testing container startup..."
if docker run --rm "$image" node --version; then
  echo "‚úì Node.js runs successfully"
else
  echo "‚úó Failed to run Node.js"
  exit 1
fi

# Test that the entrypoint script exists
echo "Testing entrypoint..."
if docker run --rm --entrypoint cat "$image" /app/packages/unleash-${usage_version}/dist/index.js > /dev/null 2>&1; then
  echo "‚úì Entrypoint file exists"
else
  echo "‚úó Entrypoint file not found"
  exit 1
fi

echo ""
echo "‚úì Smoke test passed for $image"
"""

# Ratchet tasks for GitHub Actions
[tasks."ratchet:pin"]
description = "Pin GitHub Actions to specific commit SHAs"
run = "ratchet pin .github/workflows/*.yml"

[tasks."ratchet:update"]
description = "Update pinned GitHub Actions to latest versions"
run = "ratchet update .github/workflows/*.yml"

[tasks."ratchet:lint"]
description = "Check if GitHub Actions are properly pinned"
run = "ratchet lint .github/workflows/*.yml"

[tasks."ratchet:unpin"]
description = "Unpin GitHub Actions (restore to tags)"
run = "ratchet unpin .github/workflows/*.yml"

# Helm tasks
[tasks."helm:lint"]
description = "Lint Helm charts"
run = "helm lint charts/*"

[tasks."helm:template"]
description = "Template Helm charts for debugging"
run = """
for chart in charts/*/; do
  echo "=== Templating $(basename $chart) ==="
  helm template test "$chart"
done
"""

[tasks."helm:dry-run"]
description = "Simulate Helm install (dry-run)"
run = "helm install unleash-releasechannel charts/unleash-releasechannel --dry-run"

[tasks."helm:package"]
description = "Package the Helm chart"
run = "helm package charts/unleash-releasechannel -d charts/unleash-releasechannel"

[tasks."helm:show-values"]
description = "Show default values for the chart"
run = "helm show values charts/unleash-releasechannel"

[tasks."helm:show-chart"]
description = "Show chart metadata"
run = "helm show chart charts/unleash-releasechannel"

[tasks."helm:validate"]
description = "Run all Helm validations"
depends = ["helm:lint", "helm:template"]

# Update tasks
[tasks."update:check"]
description = "Check for available package updates"
run = """
echo "=== Checking for package updates ==="
for scope in "root" "shared" "v5" "v6" "v7"; do
  echo ""
  case $scope in
    root) echo "Root workspace:"; pnpm outdated || true ;;
    shared) echo "Shared package:"; pnpm --filter @nais/unleash-shared outdated || true ;;
    *) echo "Unleash $scope (unleash-server: ${scope#v}.x):"; pnpm --filter unleash-$scope outdated || true ;;
  esac
done
"""

[tasks."update:shared"]
description = "Update shared package dependencies"
run = "cd packages/shared && pnpm update --interactive"

[tasks."update:unleash"]
description = "Update a specific unleash version (mise run update:unleash <v5|v6|v7>)"
usage = '''
arg "<version>" help="Version to update: v5, v6, or v7" {
  choices "v5" "v6" "v7"
}
'''
run = """
#!/bin/bash
set -e
VERSION=${usage_version}
MAJOR=${VERSION#v}

echo "=== Updating unleash-${VERSION} to latest ${MAJOR}.x ==="
cd packages/unleash-${VERSION}

LATEST=$(npm view unleash-server@${MAJOR} version 2>&1 | tail -1 | awk '{print $NF}' | tr -d "'")
if [ -z "$LATEST" ]; then
  echo "‚ö† Could not find unleash-server@${MAJOR}"
  exit 1
fi

CURRENT=$(node -p "require('./package.json').version")
echo "Current: $CURRENT"
echo "Latest unleash-server ${MAJOR}.x: $LATEST"

if [ "$CURRENT" = "$LATEST" ]; then
  echo "Already at latest version, updating other dependencies..."
  pnpm update
else
  pnpm add unleash-server@$LATEST
  pnpm update
  pnpm version $LATEST --no-git-tag-version
  echo "‚úì Updated unleash-${VERSION} from $CURRENT to $LATEST"
fi
"""

[tasks."update:unleash-all"]
description = "Update all unleash packages to latest within their major versions"
run = """
#!/bin/bash
set -e
echo "=== Updating all Unleash packages ==="

UPDATED_VERSIONS=""

update_version() {
  local VERSION=$1
  local MAJOR=${VERSION#v}

  echo ""
  echo "=== Unleash ${VERSION} ==="
  cd packages/unleash-${VERSION}

  LATEST=$(npm view unleash-server@${MAJOR} version 2>&1 | tail -1 | awk '{print $NF}' | tr -d "'")
  if [ -n "$LATEST" ]; then
    CURRENT=$(node -p "require('./package.json').version")
    echo "Current: $CURRENT, Latest: $LATEST"

    if [ "$CURRENT" = "$LATEST" ]; then
      echo "‚úì Already at latest version"
    else
      pnpm add unleash-server@$LATEST
      pnpm version $LATEST --no-git-tag-version
      echo "‚úì Updated from $CURRENT to $LATEST"
      UPDATED_VERSIONS="${UPDATED_VERSIONS}  - unleash-${VERSION}: ${CURRENT} ‚Üí ${LATEST}\n"
    fi
  else
    echo "‚ö† Could not find unleash-server@${MAJOR}"
  fi
  cd ../..
}

for version in v5 v6 v7; do
  update_version $version
done

echo ""
echo "=== Unleash packages update complete ==="
if [ -n "$UPDATED_VERSIONS" ]; then
  echo -e "Updated:\n${UPDATED_VERSIONS}"
else
  echo "All packages already at latest versions"
fi
"""

[tasks."update:all"]
run = """
#!/bin/bash
set -e
echo "=== Updating all dependencies ==="
echo "Unleash server versions will be constrained to their major versions."
echo ""
read -p "Continue? (y/N) " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && echo "Cancelled" && exit 0

# Store git state before updates
echo ""
echo "Capturing current state..."
git diff --name-only > /tmp/unleash-update-before.txt 2>/dev/null || true

mise run update:unleash-all

echo ""
echo "2. Updating other packages..."
for scope in "root" "shared" "v5" "v6" "v7"; do
  case $scope in
    root) echo "   - root"; pnpm update ;;
    shared) echo "   - shared"; (cd packages/shared && pnpm update) ;;
    *) echo "   - unleash-$scope devDeps"; (cd packages/unleash-$scope && pnpm update) ;;
  esac
done

echo ""
echo "3. Installing to update lockfile..."
pnpm install

echo ""
echo "=== Update Summary ==="
echo ""

# Show version changes first (most important)
echo "üì¶ Package versions:"
HAS_VERSION_CHANGES=false
for pkg in packages/unleash-v*/package.json; do
  if git diff "$pkg" | grep -E '^\\+.*"version"' > /dev/null 2>&1; then
    PKG_NAME=$(basename $(dirname "$pkg"))
    OLD=$(git diff "$pkg" | grep -E '^-.*"version"' | sed 's/.*"version": "//;s/".*//' || echo "N/A")
    NEW=$(git diff "$pkg" | grep -E '^\\+.*"version"' | sed 's/.*"version": "//;s/".*//' || echo "N/A")
    echo "  ‚úì $PKG_NAME: $OLD ‚Üí $NEW"
    HAS_VERSION_CHANGES=true
  fi
done
if [ "$HAS_VERSION_CHANGES" = false ]; then
  echo "  ‚úì All packages already at latest versions"
fi

# Show production dependency changes
echo ""
echo "üîß Production dependencies:"
HAS_PROD_CHANGES=false
for pkg in packages/unleash-v*/package.json packages/shared/package.json; do
  if git diff "$pkg" | grep -E '^\\+.*"(unleash-server|google-auth-library|jose|jsonwebtoken|log4js)"' > /dev/null 2>&1; then
    PKG_NAME=$(basename $(dirname "$pkg"))
    if [ "$HAS_PROD_CHANGES" = false ]; then
      HAS_PROD_CHANGES=true
    fi
    echo "  $PKG_NAME:"
    git diff "$pkg" | grep -E '^\\+.*"(unleash-server|google-auth-library|jose|jsonwebtoken|log4js)"' | sed 's/^+/    /' | sed 's/,$//'
  fi
done
if [ "$HAS_PROD_CHANGES" = false ]; then
  echo "  ‚úì No production dependency changes"
fi

# Count dev dependency changes
DEV_CHANGES=$(git diff packages/*/package.json package.json | grep -E '^\\+.*"@types/|^\\+.*"eslint|^\\+.*"typescript|^\\+.*"vitest|^\\+.*"prettier|^\\+.*"supertest|^\\+.*"nock' | wc -l | tr -d ' ')
echo ""
echo "üõ†Ô∏è  Dev dependencies: $DEV_CHANGES packages updated"

echo ""
echo "Review all changes: git diff"
"""

# CI task
[tasks.ci]
description = "Run full CI pipeline locally"
depends = ["lint", "build", "test", "helm:validate"]
