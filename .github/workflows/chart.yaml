name: Helm Chart

on:
  # Trigger after container images are built
  workflow_run:
    workflows: ["Main"]
    branches: [main]
    types:
      - completed
  # Also allow manual chart updates
  pull_request:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/chart.yaml'
  push:
    branches:
      - main
    paths:
      - 'charts/**'
      - '.github/workflows/chart.yaml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.9"
  HELM_VERSION: v3.19.4
  ARTIFACT_REGISTRY: europe-north1-docker.pkg.dev
  ARTIFACT_REPO: nais-io/nais/feature
  SERVICE_ACCOUNT: gh-unleash@nais-io.iam.gserviceaccount.com
  CHART_NAME: unleash-releasechannel

jobs:
  meta:
    name: Metadata
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      versions_json: ${{ steps.versions.outputs.json }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: echo "version=$(date +'%Y%m%d')-$(git rev-parse --short HEAD)" >> ${GITHUB_OUTPUT}

      - name: Detect Unleash versions and build version map
        id: versions
        run: |
          # Build a JSON object with version -> tag mapping
          # Get the tag from git tags created by Main workflow (format: v5-5.12.8-sha)
          versions_json="{"
          first=true
          for dir in packages/unleash-v*; do
            version_suffix=$(basename "$dir" | sed 's/unleash-//')
            unleash_version=$(jq -r '.dependencies["unleash-server"]' "$dir/package.json")

            # Find the latest git tag for this version (e.g., v5-5.12.8-f21986b)
            # Tags are created by Main workflow after image is pushed
            # Sort by committerdate to get the tag pointing to the most recent commit
            tag_pattern="${version_suffix}-${unleash_version}-"
            latest_tag=$(git tag -l "${tag_pattern}*" --sort=-committerdate | head -n1)

            if [ -z "$latest_tag" ]; then
              echo "Warning: No git tag found for pattern ${tag_pattern}*, using short tag"
              tag="${version_suffix}-${unleash_version}"
            else
              tag="$latest_tag"
              echo "Found tag: $tag for $version_suffix"
            fi

            if [ "$first" = true ]; then
              first=false
            else
              versions_json+=","
            fi
            versions_json+="\"${version_suffix}\":{\"tag\":\"${tag}\"}"
          done
          versions_json+="}"
          echo "json=${versions_json}" >> "$GITHUB_OUTPUT"
          echo "Detected versions: ${versions_json}"

      - name: Update Chart.yaml version
        run: |
          sed -i "s/^version:.*$/version: ${{ steps.version.outputs.version }}/g" ./charts/${{ env.CHART_NAME }}/Chart.yaml
          cat ./charts/${{ env.CHART_NAME }}/Chart.yaml

      - name: Update values.yaml with image tags
        run: |
          # Parse the versions JSON and update each tag in values.yaml
          versions='${{ steps.versions.outputs.json }}'
          for version in $(echo "$versions" | jq -r 'keys[]'); do
            tag=$(echo "$versions" | jq -r ".${version}.tag")
            # Update the tag for this version in values.yaml
            sed -i "/^  ${version}:/,/^  v[0-9]/ s/tag:.*$/tag: ${tag}/" ./charts/${{ env.CHART_NAME }}/values.yaml
          done
          cat ./charts/${{ env.CHART_NAME }}/values.yaml

      - name: Save Chart Metadata
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # ratchet:actions/upload-artifact@v4
        with:
          name: chart-metadata
          path: |
            ./charts/${{ env.CHART_NAME }}/Chart.yaml
            ./charts/${{ env.CHART_NAME }}/values.yaml

  lint-test:
    name: Lint and test Chart
    runs-on: ubuntu-latest
    needs: meta
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore Chart Metadata
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # ratchet:actions/download-artifact@v4
        with:
          name: chart-metadata
          path: ./charts/${{ env.CHART_NAME }}

      - name: Set up Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # ratchet:azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # ratchet:actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          check-latest: true

      - name: Set up chart-testing
        uses: helm/chart-testing-action@6ec842c01de15ebb84c8627d2744a0c2f2755c9f # ratchet:helm/chart-testing-action@v2.8.0

      - name: Run chart-testing (lint)
        run: ct lint --charts ./charts/${{ env.CHART_NAME }} --target-branch ${{ github.event.repository.default_branch }}

  push:
    name: Build and push Chart
    runs-on: ubuntu-latest
    needs: [meta, lint-test]
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Restore Chart Metadata
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # ratchet:actions/download-artifact@v4
        with:
          name: chart-metadata
          path: ./charts/${{ env.CHART_NAME }}

      - name: Authenticate to Google Cloud
        id: auth
        if: github.actor != 'dependabot[bot]' && (github.event_name == 'push' || github.event_name == 'workflow_run')
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093 # ratchet:google-github-actions/auth@v3.0.0
        with:
          workload_identity_provider: ${{ secrets.NAIS_IO_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ env.SERVICE_ACCOUNT }}
          token_format: access_token

      - name: Set up Cloud SDK
        if: github.actor != 'dependabot[bot]' && (github.event_name == 'push' || github.event_name == 'workflow_run')
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db # ratchet:google-github-actions/setup-gcloud@v3

      - name: Log in to Google Artifact Registry
        if: github.actor != 'dependabot[bot]' && (github.event_name == 'push' || github.event_name == 'workflow_run')
        run: |
          echo '${{ steps.auth.outputs.access_token }}' | docker login -u oauth2accesstoken --password-stdin https://${{ env.ARTIFACT_REGISTRY }}

      - name: Setup Helm
        uses: azure/setup-helm@1a275c3b69536ee54be43f2070a358922e12c8d4 # ratchet:azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Build Chart
        run: |
          helm package ./charts/${{ env.CHART_NAME }} -d ./charts/${{ env.CHART_NAME }}

      - name: Push Chart
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_run'
        run: |
          helm push ./charts/${{ env.CHART_NAME }}/*.tgz oci://${{ env.ARTIFACT_REGISTRY }}/${{ env.ARTIFACT_REPO }}

  rollout:
    name: Rollout to Fasit
    runs-on: fasit-deploy
    needs: [meta, push]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_run'
    permissions:
      id-token: write
    steps:
      - name: Deploy ${{ env.CHART_NAME }}
        uses: nais/fasit-deploy@8727ed1c7a5a465e837873e6016a9a692a6b874a # ratchet:nais/fasit-deploy@v2
        with:
          chart: oci://${{ env.ARTIFACT_REGISTRY }}/${{ env.ARTIFACT_REPO }}/${{ env.CHART_NAME }}
          version: ${{ needs.meta.outputs.version }}

  git-tag:
    runs-on: ubuntu-latest
    needs: [meta, rollout]
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_run'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4

      - name: git tag and push
        run: |
          tag="chart-${{ env.CHART_NAME }}-${{ needs.meta.outputs.version }}"
          git tag "${tag}" || true
          git push origin "${tag}" || true

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [meta, push, rollout, git-tag]
    if: always() && (github.event_name == 'push' || github.event_name == 'workflow_run')
    steps:
      - name: Generate Summary
        run: |
          versions='${{ needs.meta.outputs.versions_json }}'

          echo "# ðŸš€ Helm Chart Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Chart Details" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Chart Name** | \`${{ env.CHART_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Chart Version** | \`${{ needs.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Registry** | \`${{ env.ARTIFACT_REGISTRY }}/${{ env.ARTIFACT_REPO }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Git Tag** | \`chart-${{ env.CHART_NAME }}-${{ needs.meta.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ReleaseChannel Versions" >> $GITHUB_STEP_SUMMARY
          echo "| Version | Image Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-----------|" >> $GITHUB_STEP_SUMMARY
          for version in $(echo "$versions" | jq -r 'keys[]' | sort); do
            tag=$(echo "$versions" | jq -r ".${version}.tag")
            echo "| **${version}** | \`${tag}\` |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Metadata | ${{ needs.meta.result == 'success' && 'âœ… Success' || needs.meta.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Push Chart | ${{ needs.push.result == 'success' && 'âœ… Success' || needs.push.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Rollout to Fasit | ${{ needs.rollout.result == 'success' && 'âœ… Success' || needs.rollout.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Git Tag | ${{ needs.git-tag.result == 'success' && 'âœ… Success' || needs.git-tag.result == 'failure' && 'âŒ Failed' || 'â­ï¸ Skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## Trigger Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Event** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Ref** | \`${{ github.ref }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Actor** | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
